# OpenBSD doas configuration for Public Healthcare Platform
# Norwegian healthcare compliance with privilege separation

# Allow root to run everything (system administration)
permit nopass root

# Allow wheel group members to run as root with password
permit persist :wheel

# Healthcare platform application user
permit nopass _pubhealth as root cmd /usr/local/bin/rails
permit nopass _pubhealth as root cmd /usr/local/bin/bundle
permit nopass _pubhealth as root cmd /usr/local/bin/ruby
permit nopass _pubhealth as postgres cmd /usr/local/bin/psql
permit nopass _pubhealth as postgres cmd /usr/local/bin/pg_dump
permit nopass _pubhealth as postgres cmd /usr/local/bin/pg_restore

# Database administration
permit nopass _postgres as postgres cmd /usr/local/bin/psql
permit nopass _postgres as postgres cmd /usr/local/bin/pg_dump
permit nopass _postgres as postgres cmd /usr/local/bin/pg_restore
permit nopass _postgres as postgres cmd /usr/local/bin/createdb
permit nopass _postgres as postgres cmd /usr/local/bin/dropdb

# Web server operations
permit nopass _nginx as root cmd /usr/sbin/nginx args -s reload
permit nopass _nginx as root cmd /usr/sbin/nginx args -t
permit nopass _nginx as root cmd /usr/sbin/nginx args -s stop
permit nopass _nginx as root cmd /usr/sbin/nginx args -s quit

# Redis operations for caching
permit nopass _redis as redis cmd /usr/local/bin/redis-cli
permit nopass _redis as redis cmd /usr/local/bin/redis-server

# Log rotation and maintenance
permit nopass _pubhealth as root cmd /usr/bin/gzip args /var/log/healthcare/*
permit nopass _pubhealth as root cmd /bin/rm args /var/log/healthcare/*.old
permit nopass _pubhealth as root cmd /usr/bin/find args /var/log/healthcare -type f -mtime +30 -delete

# Certificate management for HTTPS
permit nopass _acme as root cmd /usr/sbin/acme-client
permit nopass _acme as root cmd /bin/cp args /etc/ssl/acme/*.pem /etc/ssl/
permit nopass _acme as root cmd /bin/chmod args 644 /etc/ssl/*.pem

# Backup operations for Norwegian healthcare data retention
permit nopass _backup as _postgres cmd /usr/local/bin/pg_dump
permit nopass _backup as root cmd /bin/tar args -czf /backup/healthcare-*.tar.gz /var/healthcare/data
permit nopass _backup as root cmd /usr/bin/find args /backup -name "healthcare-*.tar.gz" -mtime +2555 -delete

# System monitoring for Norwegian compliance
permit nopass _monitoring as root cmd /usr/bin/top args -b
permit nopass _monitoring as root cmd /usr/bin/vmstat
permit nopass _monitoring as root cmd /usr/bin/iostat
permit nopass _monitoring as root cmd /sbin/ifconfig
permit nopass _monitoring as root cmd /usr/bin/netstat args -an
permit nopass _monitoring as root cmd /bin/ps args aux

# Network diagnostics for healthcare platform
permit nopass _monitoring as root cmd /sbin/ping args -c 3 helsenorge.no
permit nopass _monitoring as root cmd /sbin/ping args -c 3 vipps.no
permit nopass _monitoring as root cmd /usr/bin/dig args +short helsenorge.no
permit nopass _monitoring as root cmd /usr/bin/host args helsenorge.no

# Security auditing for Norwegian healthcare compliance
permit nopass _audit as root cmd /usr/bin/last
permit nopass _audit as root cmd /usr/bin/lastlog
permit nopass _audit as root cmd /usr/bin/w
permit nopass _audit as root cmd /usr/bin/who
permit nopass _audit as root cmd /bin/cat args /var/log/secure
permit nopass _audit as root cmd /bin/cat args /var/log/authlog
permit nopass _audit as root cmd /bin/cat args /var/log/messages

# Healthcare application deployment
permit nopass deploy as _pubhealth cmd /usr/local/bin/git args pull origin main
permit nopass deploy as _pubhealth cmd /usr/local/bin/bundle args install --deployment
permit nopass deploy as _pubhealth cmd /usr/local/bin/rails args db:migrate RAILS_ENV=production
permit nopass deploy as _pubhealth cmd /usr/local/bin/rails args assets:precompile RAILS_ENV=production
permit nopass deploy as root cmd /bin/kill args -USR2 -f /var/run/puma.pid

# Emergency healthcare operations (911/113 equivalent)
permit nopass emergency as root cmd /usr/local/bin/rails args console RAILS_ENV=production
permit nopass emergency as root cmd /usr/local/bin/rails args runner RAILS_ENV=production
permit nopass emergency as postgres cmd /usr/local/bin/psql args -d healthcare_production

# Norwegian health authority compliance checks
permit nopass _compliance as root cmd /usr/local/bin/find args /var/healthcare -name "*.log" -exec grep "GDPR_VIOLATION" {} \;
permit nopass _compliance as root cmd /usr/local/bin/find args /var/healthcare -name "*.log" -exec grep "HIPAA_VIOLATION" {} \;
permit nopass _compliance as root cmd /usr/local/bin/find args /var/healthcare -name "*.log" -exec grep "UNAUTHORIZED_ACCESS" {} \;

# AI3 service management
permit nopass _ai3 as _pubhealth cmd /usr/local/bin/python args /opt/ai3/orchestrator.py
permit nopass _ai3 as _pubhealth cmd /usr/local/bin/python args /opt/ai3/vector_db.py
permit nopass _ai3 as _pubhealth cmd /usr/local/bin/curl args -X POST http://localhost:11434/api/health

# VIPPS payment processing
permit nopass _payment as _pubhealth cmd /usr/local/bin/curl args -X POST https://apitest.vipps.no/
permit nopass _payment as _pubhealth cmd /usr/local/bin/curl args -X GET https://apitest.vipps.no/

# Norwegian timezone and locale management
permit nopass _localization as root cmd /usr/sbin/ntpdate args -s time.nist.gov
permit nopass _localization as root cmd /bin/ln args -sf /usr/share/zoneinfo/Europe/Oslo /etc/localtime
permit nopass _localization as root cmd /usr/bin/locale-gen args nb_NO.UTF-8

# System maintenance windows (Norwegian business hours)
permit nopass _maintenance as root cmd /sbin/shutdown args -r +60 "Scheduled maintenance in 1 hour"
permit nopass _maintenance as root cmd /sbin/shutdown args -c "Maintenance cancelled"
permit nopass _maintenance as root cmd /etc/rc.d/nginx args restart
permit nopass _maintenance as root cmd /etc/rc.d/postgresql args restart
permit nopass _maintenance as root cmd /etc/rc.d/redis args restart

# Healthcare data encryption management
permit nopass _encryption as root cmd /usr/bin/openssl args enc -aes-256-cbc
permit nopass _encryption as root cmd /usr/bin/openssl args dec -aes-256-cbc
permit nopass _encryption as root cmd /usr/bin/gpg args --encrypt --recipient healthcare@pub.no

# Deny everything else by default
# (OpenBSD doas denies by default, this is explicit documentation)