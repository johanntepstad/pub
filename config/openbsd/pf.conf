# OpenBSD Packet Filter configuration for Public Healthcare Platform
# Security-first Norwegian healthcare compliance with pledge/unveil

# Macros for Norwegian healthcare platform
ext_if = "vio0"  # External interface
int_if = "vio1"  # Internal interface
web_ports = "{ 80, 443 }"
ssh_port = "22"
api_ports = "{ 3000, 8080 }"

# Norwegian healthcare networks (example ranges)
healthcare_nets = "{ 192.168.100.0/24, 10.10.0.0/16 }"
management_nets = "{ 192.168.1.0/24 }"

# Rate limiting for DDoS protection
table <bruteforce> persist
table <abuse> persist file "/etc/pf/abuse_ips.txt"

# Norwegian health authority approved endpoints
table <health_authorities> const { \
    213.179.0.0/16, \    # Helsedirektoratet
    194.19.137.0/24, \   # Helsenorge.no
    185.9.0.0/16 \       # Norwegian health networks
}

# VIPPS payment gateway endpoints
table <vipps_endpoints> const { \
    52.213.0.0/16, \     # VIPPS production
    54.229.0.0/16, \     # VIPPS test
    63.32.0.0/16 \       # VIPPS backup
}

# AI provider endpoints
table <ai_providers> const { \
    20.14.0.0/16, \      # OpenAI
    52.84.0.0/16, \      # Anthropic  
    104.18.0.0/16, \     # Cloudflare (for APIs)
    172.67.0.0/16 \      # Additional CDN ranges
}

# Default deny policy
set block-policy drop
set loginterface $ext_if
set optimization aggressive
set timeout interval 10
set timeout frag 30
set timeout src.track 300

# Enable logging for security analysis
set loginterface $ext_if

# Scrub packets for Norwegian compliance
match in all scrub (no-df random-id max-mss 1440)

# Network Address Translation
nat on $ext_if from $int_if:network to any -> ($ext_if)

# Redirection for load balancer
rdr on $ext_if proto tcp from any to any port 80 -> 127.0.0.1 port 3000
rdr on $ext_if proto tcp from any to any port 443 -> 127.0.0.1 port 3000

# Rate limiting rules for healthcare platform
pass in quick on $ext_if proto tcp from any to any port $ssh_port \
    flags S/SA keep state \
    (max-src-conn 3, max-src-conn-rate 3/60, \
     overload <bruteforce> flush global)

# Block known abuse sources
block drop quick from <abuse>
block drop quick from <bruteforce>

# Allow loopback
pass quick on lo0

# Allow established connections
pass out quick on $ext_if proto tcp from any to any keep state
pass out quick on $ext_if proto udp from any to any keep state

# ICMP for Norwegian network diagnostics
pass in on $ext_if inet proto icmp icmp-type echoreq
pass out on $ext_if inet proto icmp

# SSH access with Norwegian compliance logging
pass in on $ext_if proto tcp from $management_nets to any port $ssh_port \
    flags S/SA keep state \
    (max-src-conn 2, max-src-conn-rate 2/60)

# HTTP/HTTPS for healthcare platform
pass in on $ext_if proto tcp from any to any port $web_ports \
    flags S/SA keep state \
    (max-src-conn 100, max-src-conn-rate 50/60, \
     overload <bruteforce> flush global)

# API endpoints with enhanced rate limiting
pass in on $ext_if proto tcp from any to any port $api_ports \
    flags S/SA keep state \
    (max-src-conn 20, max-src-conn-rate 10/60, \
     overload <bruteforce> flush global)

# Allow outbound to Norwegian health authorities
pass out on $ext_if proto tcp from any to <health_authorities> port { 80, 443 } \
    keep state

# Allow VIPPS payment processing
pass out on $ext_if proto tcp from any to <vipps_endpoints> port { 80, 443 } \
    keep state

# Allow AI provider access with monitoring
pass out on $ext_if proto tcp from any to <ai_providers> port { 80, 443 } \
    keep state

# DNS for Norwegian healthcare domains
pass out on $ext_if proto udp from any to any port 53 keep state
pass out on $ext_if proto tcp from any to any port 53 keep state

# NTP for Norwegian timezone synchronization
pass out on $ext_if proto udp from any to any port 123 keep state

# Block everything else
block log all

# Emergency access rule (activate only in crisis)
# pass in quick on $ext_if proto tcp from 192.168.1.100 to any port 22

# Healthcare data protection - block suspicious patterns
block drop quick inet proto tcp from any to any port 3306  # MySQL
block drop quick inet proto tcp from any to any port 5432  # PostgreSQL
block drop quick inet proto tcp from any to any port 1433  # MSSQL
block drop quick inet proto tcp from any to any port 27017 # MongoDB

# Log Norwegian healthcare compliance violations
pass log (all) in on $ext_if proto tcp from any to any port { 80, 443 } \
    flags S/SA keep state

# Block common attack vectors
block drop quick from any to any port { 135, 139, 445, 1433, 1434 }
block drop quick inet proto tcp from any port = 0 to any
block drop quick inet proto udp from any port = 0 to any

# Rate limit ICMP to prevent ping floods
pass in on $ext_if inet proto icmp from any to any \
    keep state (max-src-conn-rate 5/60)

# Healthcare platform specific protections
antispoof quick for { lo0, $ext_if }

# Block IPv6 for simplified Norwegian compliance
block quick inet6 all